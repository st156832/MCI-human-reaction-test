<html>

<head>
    <title>Human Capabilities - Reaction test</title>
    <style>
        body {
            font-family: sans-serif;
        }

        .centered {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        .centeredX {
            margin: 0;
            position: absolute;
            left: 50%;
            -ms-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        p::after {
            content: '\200b';
        }

        #stimulus {
            height: 100px;
            width: 100px;
            position: relative;
            border-radius: 50%;
        }

        #cutout {
            width: 50%;
            height: 50%;
            background-color: rgb(255, 255, 255);
            position: absolute;
            top: 25%;
            left: 25%;
            border-radius: 50%;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="experiment" class="centered">
        <h1 id="title" style="text-align: center;">Basic reaction time trial</h1>
        <h2 id="instruction" style="text-align: center;">Press space to start!</h2>
        <div id="stimulus" class="centeredX">
            <div id="cutout"></div>
        </div>
        <div id="results" style="text-align: center; margin-top: 10px;">
            <p id="time" style="font-weight: bold;"></p>
            <p id="count"></p>
            <p id="errors"></p>
            <p id="mean"></p>
            <p id="sd"></p>
        </div>
    </div>
    <script>
        // if true, the experiment is currently active
        let experimentActive = false;

        // if true, the stimulus is currently visible and the user should press space
        let stimulusIsVisible = false;

        // time at which the stimulus last appeared (in milliseconds, see Date.now())
        let stimulusTimestamp;

        // ID of the timeout that is scheduled to make the stimulus appear.
        // Used to cancel tests when the experiment ends.
        let testStimulusTimeout;

        // recorded reaction times in milliseconds
        let times = [];

        // tracks the number of times the participant pressed the button prematurely
        let errors = 0;

        // DOM elements
        let timeElement = document.getElementById('time');
        let countElement = document.getElementById('count');
        let meanElement = document.getElementById('mean');
        let stdDevElement = document.getElementById('sd');
        let instructionElement = document.getElementById('instruction');
        let stimulusElement = document.getElementById('stimulus');
        let errorElement = document.getElementById('errors');

        function getMean(data) {
            let sum = 0;
            for (let value of data) sum += value;
            return sum / data.length;
        }

        function getStandardDeviation(data) {
            let mean = getMean(data);
            let squareSum = 0;
            for (let value of data) squareSum += (value - mean) ** 2;
            return Math.sqrt(squareSum / data.length);
        }

        function clearResults() {
            timeElement.textContent = '';
            countElement.textContent = '';
            meanElement.textContent = '';
            stdDevElement.textContent = '';
            errorElement.textContent = '';
        }

        function showResults() {
            let meanDeltaTime = getMean(times);
            let stdDev = getStandardDeviation(times);

            timeElement.textContent = 'Press \'d\' to begin the next experiment'
            countElement.textContent = 'Count: ' + times.length;
            meanElement.textContent = 'Mean: ' + Math.round(meanDeltaTime) + ' ms';
            stdDevElement.textContent = 'SD: ' + Math.round(stdDev) + ' ms';
            errorElement.textContent = 'Errors: ' + errors
        }

        function setStimulusColor(newColor) {
            stimulusElement.style.backgroundColor = newColor;
        }

        function startTestTrial() {
            // reset the stimulus
            setStimulusColor('black');
            stimulusIsVisible = false;

            // schedule the stimulus to appear after a random amount of time
            let timeToWaitInSeconds = Math.random() * 4 + 2; // 2 - 6s
            testStimulusTimeout = setTimeout(showStimulus, timeToWaitInSeconds * 1000);
        }

        function showStimulus() {
            setStimulusColor('green');
            stimulusIsVisible = true;
            stimulusTimestamp = Date.now();
        }

        function recordStimulusReactionTime() {
            let deltaTime = Date.now() - stimulusTimestamp;
            times.push(deltaTime);
            timeElement.textContent = deltaTime + ' ms';
        }

        function startExperiment() {
            clearResults(); // clear results of any previous tests
            instructionElement.textContent = "Press space when the color changes! Press 'a' for results!";

            // reset data and start tests
            times = [];
            experimentActive = true;
            startTestTrial();
        }

        function stopExperiment() {
            // cancel any ongoing tests
            clearTimeout(testStimulusTimeout);
            stimulusIsVisible = false;
            experimentActive = false;

            // reset instruction and show results
            instruction.textContent = (times.length + errors > 0) ? 'Press space to start! Press \'b\' to download your results!' : 'Press space to restart!';
            showResults();
        }

        function startNextExperiment() {
            experiments = sessionStorage.getItem('experiments');
            
            nextExperiment = experiments[Math.floor(Math.random() * experiments.length)];
            experiments.splice(experiments.indexOf(nextExperiment), 1)
            sessionStorage.setItem("experiments", experiments);

            window.location.href = experiment;
        }

        function downloadResults() {
            const rows = [
                ["Experiment", "iterations", "mean", "errors", "SD"],
                ["0", times.length, getMean(times), errors, getStandardDeviation(times)]
            ];

            let csvContent = "data:text/csv;charset=utf-8,";

            rows.forEach(function(rowArray) {
                let row = rowArray.join(",");
                csvContent += row + "\r\n";
            });

            var encodedUri = encodeURI(csvContent);
            window.open(encodedUri);
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === ' ') {
                // the user pressed the space key
                if (!experimentActive) {
                    // start the experiment if it wasn't active
                    startExperiment();
                    return;
                }

                if (stimulusIsVisible) {
                    // record reaction time
                    recordStimulusReactionTime();
                    // start next trial
                    startTestTrial();
                } else {
                    //record premature input and give brief visual indicator
                    errors++
                    setStimulusColor('red');
                    setTimeout(() => { setStimulusColor('black'); }, 200)
                }
            } else if (event.key === 'a' && (errors > 0 | times.length > 0)) {
                if (experimentActive) {
                    // stop the experiment and show results
                    stopExperiment();
                }
            } else if (!experimentActive) {
                if (event.key === 'd') {
                    startNextExperiment();
                } else if (event.key === 'b') {
                    downloadResults();
                }

            }    
        });
    </script>
</body>

</html>